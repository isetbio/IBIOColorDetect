function detectionThresholdData = c_PoirsonAndWandell96RunSession(runConfigID, nTrainingSamples, performanceClassifierTrainingSamples, ...
    computeMosaic, computeResponses, findPerformances, visualizeResponses, visualizePerformances, ...
    visualizeMosaic, visualizeSpatialScheme, classifierSignalList, classifierTypeList, pcaComponentsNum)
%
%
    nContrastsPerDirection = 12;
    lowContrast = 5e-4;
    highContrast = 5e-1;
        
    % Freeze photon-isomerization & photocurrent noise
    freezeNoise = false;
    
    % Size of cone mosaic
    coneMosaicFOVDegs = 1.25;
    
    allRunConfigs = { ...
        {'random',  struct('spatialFrequency', 2,  'meanLuminance', 20) } ... 
        {'random',  struct('spatialFrequency', 2,  'meanLuminance', 200)} ...  
        {'random',  struct('spatialFrequency', 10, 'meanLuminance', 200)} ...
        {'frozen0', struct('spatialFrequency', 2,  'meanLuminance', 20) } ...
        {'frozen0', struct('spatialFrequency', 2,  'meanLuminance', 200)} ...
        {'frozen0', struct('spatialFrequency', 10, 'meanLuminance', 200)} ...
        };
    
    % Select the one we want
    theSelectedRunConfig = allRunConfigs{runConfigID};
    emPathTypesList = {theSelectedRunConfig{1}};
    stimParamsList = {theSelectedRunConfig{2}};
    
    % Computation foptions
    displayResponseComputationProgress = false;
    
    % Go !
    detectionThresholdData = batchJob(computeMosaic, computeResponses, displayResponseComputationProgress, visualizeMosaic, visualizeSpatialScheme, visualizeResponses, findPerformances, visualizePerformances, ...
        lowContrast, highContrast, nContrastsPerDirection, nTrainingSamples, freezeNoise,  coneMosaicFOVDegs, emPathTypesList, stimParamsList, ...
        classifierSignalList, classifierTypeList, pcaComponentsNum, performanceClassifierTrainingSamples);
    
    if (1==2)
        % Optionally, assess performance as a function of integrated response
        % Response integration times (in milliseconds) to examine
        evidenceIntegrationTimes = ([6 18 30 48 60 78 90 108 120 138 150 168 186 210]-1); % (5:10:250); %-([6 18 30 48 60 78 90 108 120 138 150 168 186 210]-1); % (5:10:250);
        evidenceIntegrationTimes = ([6 18 30 48 60 90 120 150 186 210]-1);
        % Stimulus & performance params to examine
        spatialFrequency = 10;
        meanLuminance = 200;
        emPathType = 'frozen0';
        classifier = 'mlpt';
        performanceSignal = 'isomerizations';
        
        findPerformancesForDifferentEvidenceIntegrationTimes(...
            spatialFrequency, meanLuminance, nTrainingSamples, ...
            emPathType, classifier, performanceSignal, ...
            evidenceIntegrationTimes);
    end
    
end


function detectionThresholdData = batchJob(computeMosaic, computeResponses, displayResponseComputationProgress, visualizeMosaic, visualizeSpatialScheme, visualizeResponses, findPerformances, visualizePerformances, ...
        lowContrast, highContrast, nContrastsPerDirection, nTrainingSamples, freezeNoise, coneMosaicFOVDegs, emPathTypesList, stimParamsList, classifierSignalList, classifierTypeList, pcaComponentsNum, performanceClassifierTrainingSamples)

    % Start timing
    tBegin = clock;    
    
    % Only compute the mosaic once
    mosaicAlreadyComputed = false;
        
    detectionThresholdData = {};
    
    for emPathTypeIndex = 1:numel(emPathTypesList)
        
        % Get the emPathType
        emPathType = emPathTypesList{emPathTypeIndex};
        
        for stimConditionIndex = 1:numel(stimParamsList)
            % Get the stim params
            params = stimParamsList{stimConditionIndex};
            
            % Compute responses
            if (computeResponses) || (visualizeResponses)
                 % Inform the user regarding what we are currently working on
                 fprintf('Computing/visualizing responses for %2.2f c/deg, %d cd/m2 with ''%s'' emPaths.\n', ...
                            params.spatialFrequency, params.meanLuminance, emPathType);
                    
                 if (mosaicAlreadyComputed)
                     computeMosaic = false;
                 end
                 
                 c_PoirsonAndWandell96Replicate(...
                    'spatialFrequency', params.spatialFrequency, ...
                    'meanLuminance', params.meanLuminance, ...
                    'nContrastsPerDirection', nContrastsPerDirection, ...
                    'lowContrast', lowContrast, ...
                    'highContrast', highContrast, ...
                    'nTrainingSamples', nTrainingSamples, ...
                    'emPathType', emPathType, ...
                    'freezeNoise', freezeNoise, ...
                    'visualizeMosaic', visualizeMosaic, ...
                    'computeMosaic', computeMosaic, ...
                    'coneMosaicFOVDegs', coneMosaicFOVDegs, ...
                    'computeResponses', computeResponses, ...
                    'visualizeResponses', visualizeResponses, ...
                    'visualizeSpatialScheme', visualizeSpatialScheme , ...
                    'displayResponseComputationProgress', displayResponseComputationProgress, ...
                    'findPerformance', false);
                
                 mosaicAlreadyComputed = true;
            end % if (computeResponses)
            
            % Find/visualize performance
            if (findPerformances) || (visualizePerformances)
                for classifierTypeIndex = 1:numel(classifierTypeList)
                    % Get the classifier name
                    classifierTypeName = classifierTypeList{classifierTypeIndex};
                    for classifierSignalIndex = 1:numel(classifierSignalList)
                        % Get the signal name on which to measure performance
                        performanceSignalName = classifierSignalList{classifierSignalIndex};
                        if (~strcmp(performanceSignalName, 'isomerizations')) && (strcmp(classifierTypeName, 'mlpt'))
                            fprintf(2,'Finding performance using an <strong>%s</strong> classifier on <strong>%s</strong> is not feasible. Skipping...\n', classifierTypeName, performanceSignalName);
                            continue;
                        end

                        [~,~, detectionThresholdContrast] = c_PoirsonAndWandell96Replicate(...
                            'spatialFrequency', params.spatialFrequency, ...
                            'meanLuminance', params.meanLuminance, ...
                            'nContrastsPerDirection', nContrastsPerDirection, ...
                            'lowContrast', lowContrast, ...
                            'highContrast', highContrast, ...
                            'nTrainingSamples', nTrainingSamples, ...
                            'emPathType', emPathType, ...
                            'freezeNoise', freezeNoise, ...
                            'coneMosaicFOVDegs', coneMosaicFOVDegs, ...
                            'computeResponses', false, ...
                            'visualizeResponses', false, ...
                            'visualizeSpatialScheme', visualizeSpatialScheme , ...
                            'findPerformance', findPerformances, ...
                            'visualizePerformance', visualizePerformances, ...
                            'fitPsychometric', true, ...
                            'performanceSignal', performanceSignalName, ...
                            'performanceClassifier', classifierTypeName, ...
                            'performanceClassifierTrainingSamples', performanceClassifierTrainingSamples, ...
                            'pcaComponentsNum', pcaComponentsNum ...
                            );  % findPerformances
                        
                        d.emPathType = emPathType;
                        d.stimParams = params;
                        d.performanceSignalName = performanceSignalName;
                        d.classifierTypeName = classifierTypeName;
                        d.detectionThresholdContrast = detectionThresholdContrast;
                        detectionThresholdData{numel(detectionThresholdData)+1} = d;
            
                        fprintf('Detection threshold contrast for <strong>%s</strong> signals using <strong>''%s''</strong> classifier: <strong>%f</strong>\n',performanceSignalName,  classifierTypeName, detectionThresholdContrast);
                    end % classifierSignalIndex
                end % classifierTypeIndex
            end % if (findPerformances) || (visualizePerformances)
            
        end % stimConditionIndex
    end % emPathTypeIndex
    
    tEnd = clock;
    timeLapsed = etime(tEnd,tBegin);
    fprintf('BATCH JOB: Completed in %.2f hours. \n', timeLapsed/60/60);
end


% Method to assess performance as a function of the included response duration
function findPerformancesForDifferentEvidenceIntegrationTimes(...
    spatialFrequency, meanLuminance, nTrainingSamples, ...
    emPathType, classifier, performanceSignal, ...
    evidenceIntegrationTimes)

    for k = 1:numel(evidenceIntegrationTimes)
        evidenceIntegrationTime = evidenceIntegrationTimes(k);
        fprintf(2, 'Finding performance for ''%s'' EMpaths using an %s classifier operating on %2.1f milliseconds of the %s signals.\n', emPathType, classifier, evidenceIntegrationTime, performanceSignal);
        c_PoirsonAndWandell96Replicate(...
                'spatialFrequency', spatialFrequency, ...
                'meanLuminance', meanLuminance, ...
                'nTrainingSamples', nTrainingSamples, ...
                'computeResponses', false, ...
                'emPathType', emPathType, ...
                'visualizeResponses', false, ...
                'findPerformance', true, ...
                'performanceSignal', performanceSignal, ...
                'performanceClassifier', classifier, ...
                'performanceEvidenceIntegrationTime', evidenceIntegrationTime ....
                );
    end % k
    
    % And the the full time course
    c_PoirsonAndWandell96Replicate(...
                'spatialFrequency', spatialFrequency, ...
                'meanLuminance', meanLuminance, ...
                'nTrainingSamples', nTrainingSamples, ...
                'computeResponses', false, ...
                'emPathType', emPathType, ...
                'visualizeResponses', false, ...
                'findPerformance', true, ...
                'performanceSignal', performanceSignal, ...
                'performanceClassifier', classifier, ...
                'performanceEvidenceIntegrationTime', [] ....
                );       
end
